<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klaim Kupon - Mesin Capit Pro</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { background: #0b0b0b; color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 450px; margin-top: 50px; }
        .card { 
            background: #161616; border: 2px solid #d4af37; border-radius: 20px; 
            padding: 25px; box-shadow: 0 0 40px rgba(212, 175, 55, 0.2);
        }
        .img-game { width: 100%; border-radius: 15px; margin-bottom: 20px; border: 1px solid #333; }
        .btn-claim { 
            background: linear-gradient(45deg, #d4af37, #f4e07d); color: #000; 
            font-weight: bold; border: none; padding: 12px; border-radius: 10px; width: 100%;
            transition: 0.3s;
        }
        .btn-claim:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4); }
        input { 
            background: #222 !important; border: 1px solid #444 !important; 
            color: #d4af37 !important; text-align: center; font-size: 1.3rem; 
            font-weight: bold; margin-bottom: 20px; text-transform: uppercase;
        }
        .footer-text { font-size: 0.75rem; color: #555; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card text-center">
        <h2 style="color: #d4af37; text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);">üïπÔ∏è MESIN CAPIT</h2>
        <p class="text-secondary small">Masukkan kode kupon untuk melihat hadiahmu</p>
        <hr style="border-color: #333;">
        
        <img src="loading.gif" alt="Game" class="img-game">

        <div class="mb-3">
            <input type="text" id="couponInput" class="form-control" placeholder="REGE-XXXXXX">
        </div>

        <button onclick="prosesKlaim()" class="btn btn-claim">KLAIM SEKARANG</button>

        <div class="footer-text text-uppercase">
            Cloud Database: Firebase Realtime (Active)
        </div>
    </div>
</div>

<script>
    // --- KONFIGURASI FIREBASE ASLI ANDA ---
    const firebaseConfig = {
        apiKey: "AIzaSyCQG-NkD9rLLtIFOXBCfdNZ_yFRfx6LPrg",
        authDomain: "mesin-capit-bd535.firebaseapp.com",
        databaseURL: "https://mesin-capit-bd535-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "mesin-capit-bd535",
        storageBucket: "mesin-capit-bd535.firebasestorage.app",
        messagingSenderId: "978657704206",
        appId: "1:978657704206:web:ee29d7ce6007d3fed93f5f",
        measurementId: "G-S4YD815KXP"
    };

    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    async function prosesKlaim() {
        const inputKode = document.getElementById('couponInput').value.trim().toUpperCase();

        if (!inputKode) {
            Swal.fire('Oops!', 'Masukkan kode kupon dulu ya.', 'warning');
            return;
        }

        Swal.fire({
            title: 'Mencocokkan Kode...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        // Mencari data langsung di Firebase (Path: kupon/KODE)
        db.ref('kupon/' + inputKode).once('value')
            .then((snapshot) => {
                const data = snapshot.val();

                if (data && data.status === "aktif") {
                    // JIKA KUPON VALID
                    Swal.fire({
                        icon: 'success',
                        title: 'KUPON BERHASIL!',
                        html: `Hadiah Anda: <br><b style="font-size: 24px; color: gold;">${data.hadiah}</b>`,
                        confirmButtonText: 'Terima Kasih!'
                    }).then(() => {
                        // OTOMATIS UBAH STATUS DI FIREBASE JADI TERPAKAI
                        db.ref('kupon/' + inputKode).update({
                            status: "terpakai",
                            waktu_klaim: new Date().toLocaleString()
                        });
                        document.getElementById('couponInput').value = ""; // Bersihkan input
                    });
                } else if (data && data.status === "terpakai") {
                    // JIKA KUPON SUDAH PERNAH DIPAKAI
                    Swal.fire('Gagal!', 'Maaf, kupon ini sudah pernah diklaim sebelumnya.', 'error');
                } else {
                    // JIKA KUPON TIDAK DITEMUKAN
                    Swal.fire('Tidak Ditemukan', 'Kode kupon salah atau sudah kadaluarsa.', 'error');
                }
            })
            .catch((error) => {
                console.error(error);
                Swal.fire('Database Error', 'Gagal menyambung ke server cloud.', 'error');
            });
    }
</script>

</body>
</html>
